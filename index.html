<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSiP • EDURANGA - Podpis Elektroniczny</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4 font-sans text-slate-900">

    <div id="app-container" class="max-w-2xl w-full bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
        
        <div class="bg-blue-700 p-6 text-white text-center">
            <h1 class="text-2xl font-bold tracking-tight">WSiP • EDURANGA</h1>
            <p class="text-blue-100 text-sm mt-1">Regulamin i Umowa Konta Użytkownika</p>
        </div>

        <div class="flex w-full h-1 bg-slate-100">
            <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 33%"></div>
        </div>

        <div class="p-8">
            <div id="step-1" class="space-y-6">
                <div class="prose prose-slate max-h-96 overflow-y-auto pr-4 border-b border-slate-100 pb-4">
                    <h2 class="text-lg font-bold mb-4">Regulamin Platformy</h2>
                    <ol class="list-decimal space-y-3 pl-4 text-slate-700">
                        <li><strong>Zakaz udostępniania:</strong> Zakaz udostępniania konta osobom trzecim.</li>
                        <li><strong>Bazy zadań:</strong> Nie wolno zapisywać baz zadań, jedynie testy.</li>
                        <li><strong>Hasło:</strong> Hasło będzie zmieniane co parę miesięcy.</li>
                        <li><strong>Dostęp:</strong> Konto może być w każdej chwili odebrane.</li>
                        <li><strong>Koszty:</strong> Posiadanie konta jest darmowe.</li>
                        <li><strong>Dane:</strong> Zakaz zmieniania danych i haseł profilu.</li>
                    </ol>
                </div>
                <button onclick="goToStep(2)" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl flex items-center justify-center gap-2 transition-all transform hover:scale-[1.02]">
                    Przeczytałem i przechodzę do podpisu <i data-lucide="chevron-right"></i>
                </button>
            </div>

            <div id="step-2" class="hidden space-y-6">
                <div class="text-center">
                    <i data-lucide="pen-tool" class="mx-auto text-blue-600 mb-2"></i>
                    <h2 class="text-xl font-bold">Podpis Elektroniczny</h2>
                    <p class="text-slate-500 text-sm">Złóż podpis poniżej (myszką lub palcem)</p>
                </div>

                <div class="relative border-2 border-dashed border-slate-300 rounded-xl bg-slate-50">
                    <canvas id="signature-canvas" width="600" height="250" class="w-full h-64 touch-none cursor-crosshair"></canvas>
                </div>

                <div class="flex gap-4">
                    <button onclick="clearCanvas()" class="flex-1 border border-slate-300 py-3 px-4 rounded-xl flex items-center justify-center gap-2 hover:bg-slate-100 transition-colors">
                        <i data-lucide="trash-2"></i> Wyczyść
                    </button>
                    <button id="save-btn" onclick="saveToFirebase()" class="flex-[2] bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition-all">
                        <i data-lucide="save"></i> Podpisz i Wyślij
                    </button>
                </div>
                <p id="status-msg" class="text-red-500 text-center text-sm hidden"></p>
            </div>

            <div id="step-3" class="hidden py-12 text-center space-y-4">
                <div class="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="check-circle" class="text-green-600 w-12 h-12"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800">Umowa podpisana!</h2>
                <p class="text-slate-600">Twój podpis został zapisany w systemie Firebase.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDmmID6nm3Y3f3w0gb2AB2vXm0S2L7NHsc",
            authDomain: "regulamin-6f74c.firebaseapp.com",
            projectId: "regulamin-6f74c",
            storageBucket: "regulamin-6f74c.firebasestorage.app",
            messagingSenderId: "829914362482",
            appId: "1:829914362482:web:54fc73f2aba61c3e4908eb"
        };

        // Inicjalizacja
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;

        // Logowanie anonimowe
        signInAnonymously(auth).then(user => {
            userId = user.user.uid;
            console.log("Zalogowano anonimowo:", userId);
        }).catch(err => console.error("Auth error:", err));

        // Obsługa Canvas (Rysowanie)
        const canvas = document.getElementById('signature-canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX || e.touches[0].clientX) - rect.left,
                y: (e.clientY || e.touches[0].clientY) - rect.top
            };
        }

        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('touchstart', start);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchmove', draw);
        window.addEventListener('mouseup', stop);
        window.addEventListener('touchend', stop);

        function start(e) {
            drawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            if(e.touches) e.preventDefault();
        }

        function draw(e) {
            if (!drawing) return;
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 2;
            ctx.lineCap = "round";
            ctx.stroke();
            if(e.touches) e.preventDefault();
        }

        function stop() { drawing = false; }

        window.clearCanvas = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };

        // Przełączanie kroków
        window.goToStep = (step) => {
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = '66%';
            lucide.createIcons(); // Odśwież ikonki
        };

        // Zapis do Firebase
        window.saveToFirebase = async () => {
            const btn = document.getElementById('save-btn');
            const status = document.getElementById('status-msg');
            
            btn.disabled = true;
            btn.innerText = "Zapisywanie...";

            try {
                const dataUrl = canvas.toDataURL();
                await addDoc(collection(db, "artifacts", "regulamin-6f74c-app", "signatures"), {
                    userId: userId,
                    signature: dataUrl,
                    timestamp: serverTimestamp(),
                    date: "2026-01-02"
                });

                document.getElementById('step-2').classList.add('hidden');
                document.getElementById('step-3').classList.remove('hidden');
                document.getElementById('progress-bar').style.width = '100%';
                document.getElementById('progress-bar').classList.replace('bg-blue-500', 'bg-green-500');
            } catch (e) {
                console.error(e);
                status.innerText = "Błąd zapisu. Sprawdź konsolę i uprawnienia Firestore.";
                status.classList.remove('hidden');
                btn.disabled = false;
                btn.innerText = "Podpisz i Wyślij";
            }
            lucide.createIcons();
        };

        // Inicjalizacja ikonek na starcie
        lucide.createIcons();
    </script>
</body>
</html>
